#!/usr/bin/env bash
set -euo pipefail

# --- Usage check ---
if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <input_directory> <output_file.m4b>"
    exit 1
fi

INPUT_DIR="$1"
OUTPUT_FILE="$2"

# --- Dependency check ---
for cmd in ffmpeg ffprobe realpath; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is not in PATH."
        exit 1
    fi
done

# --- Verify input directory ---
if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: input directory '$INPUT_DIR' not found."
    exit 1
fi

TMP_DIR="$(mktemp -d)"
LIST_FILE="$TMP_DIR/concat_list.txt"
CHAPTERS_FILE="$TMP_DIR/chapters.txt"

# --- Collect MP3 files ---
mapfile -t mp3_files < <(find "$INPUT_DIR" -type f -iname '*.mp3' | sort -V)
if [ "${#mp3_files[@]}" -eq 0 ]; then
    echo "Error: No MP3 files found in $INPUT_DIR"
    exit 1
fi

# --- Create concat list with absolute paths and proper escaping ---
> "$LIST_FILE"
for f in "${mp3_files[@]}"; do
    abs_path=$(realpath "$f")
    safe_path=$(printf "%s" "$abs_path" | sed "s/'/'\\\\''/g")
    echo "file '$safe_path'" >> "$LIST_FILE"
done

# --- Build chapters metadata ---
echo ";FFMETADATA1" > "$CHAPTERS_FILE"
current_start=0
part=1

for f in "${mp3_files[@]}"; do
    part_title=$(basename "$f" .mp3)
    duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$f")
    duration=${duration%.*}
    chapter_end=$((current_start + duration))

    {
        echo "[CHAPTER]"
        echo "TIMEBASE=1/1000"
        echo "START=$((current_start * 1000))"
        echo "END=$((chapter_end * 1000))"
        echo "title=Part: $part_title"
    } >> "$CHAPTERS_FILE"

    current_start=$chapter_end
    ((part++))
done

# --- Run ffmpeg ---
ffmpeg -hide_banner -f concat -safe 0 -i "$LIST_FILE" \
    -i "$CHAPTERS_FILE" \
    -map_metadata 1 \
    -c:a aac -b:a 64k -f mp4 "$OUTPUT_FILE"

rm -rf "$TMP_DIR"

echo "âœ… Created audiobook: $OUTPUT_FILE"

