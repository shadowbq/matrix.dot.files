#!/usr/bin/env bash
# /opt/scripts/pdf_watermark.sh
# @author: Nestor Urquiza
# @date: 20180323
# @description: Creates a temporary pdfmark and merges it with the input pdf to produce a watermark with a custom text
#

function echo_err() {
  echo -ne "${RED}"
  cat <<<"$@" 1>&2
  echo -ne "${NORMAL}"
}

USAGE="Usage: $(basename "$0") <pdf_from_file> <pdf_to_file> <watermark> [password]"
 
if [ $# -lt "3" ] 
then
    echo "$USAGE"
    exit 1 
fi

command -v gs >/dev/null 2>&1
if [ $? -eq 1 ]; then
  echo_err "[WARNING] GS (GhostScript) not found in path. "
  exit 1
fi

pdf_from_file=$1
pdf_to_file=$2
watermark=$3
password=$4

#tmpfile=$(mktemp /tmp/pdf_watermark.XXXXXX)
tmpfile=mark.ps

font="/Helvetica-Bold 72 selectfont"
color=".75 setgray"
angle=45


! read -d '' pdf_mark <<EOF
<<
   /EndPage
   {
     2 eq { pop false }
     {
         gsave      
         /Helvetica_Bold 72 selectfont
         .85 setgray 
         .6 .setfillconstantalpha
         220 270 moveto 50 rotate (${watermark}) show
         grestore
         true
     } ifelse
   } bind
>> setpagedevice
EOF

gs -dBATCH -dNOPAUSE -q -sDEVICE=pdfwrite -dALLOWPSTRANSPARENCY -dSAFER -dCompatibilityLevel="1.5" -dPDFSETTINGS="/printer" -sOutputFile="$pdf_to_file" -c "$pdf_mark" -f "$pdf_from_file"

